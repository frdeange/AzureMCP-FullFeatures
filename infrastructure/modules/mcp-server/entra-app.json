{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "3943911509924351084"
    }
  },
  "parameters": {
    "entraAppDisplayName": {
      "type": "string",
      "metadata": {
        "description": "Display name for the Entra Application"
      }
    },
    "entraAppUniqueName": {
      "type": "string",
      "metadata": {
        "description": "Unique name for the Entra Application"
      }
    }
  },
  "variables": {
    "entraAppRoleValue": "Mcp.Tools.ReadWrite.All",
    "entraAppRoleId": "[guid(subscription().id, variables('entraAppRoleValue'))]",
    "entraAppRoleDisplayName": "Azure MCP Tools ReadWrite All",
    "entraAppRoleDescription": "Application permission for Azure MCP tool calls"
  },
  "imports": {
    "microsoftGraphV1": {
      "provider": "MicrosoftGraph",
      "version": "1.0.0"
    }
  },
  "resources": {
    "entraApp": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications@v1.0",
      "properties": {
        "uniqueName": "[parameters('entraAppUniqueName')]",
        "displayName": "[parameters('entraAppDisplayName')]",
        "appRoles": [
          {
            "id": "[variables('entraAppRoleId')]",
            "displayName": "[variables('entraAppRoleDisplayName')]",
            "description": "[variables('entraAppRoleDescription')]",
            "value": "[variables('entraAppRoleValue')]",
            "isEnabled": true,
            "allowedMemberTypes": [
              "Application"
            ]
          }
        ]
      }
    },
    "entraAppUpdate": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/applications@v1.0",
      "properties": {
        "uniqueName": "[parameters('entraAppUniqueName')]",
        "displayName": "[parameters('entraAppDisplayName')]",
        "appRoles": "[reference('entraApp').appRoles]",
        "identifierUris": [
          "[format('api://{0}', reference('entraApp').appId)]"
        ]
      },
      "dependsOn": [
        "entraApp"
      ]
    },
    "entraServicePrincipal": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/servicePrincipals@v1.0",
      "properties": {
        "appId": "[reference('entraApp').appId]"
      },
      "dependsOn": [
        "entraApp"
      ]
    }
  },
  "outputs": {
    "entraAppClientId": {
      "type": "string",
      "value": "[reference('entraApp').appId]"
    },
    "entraAppObjectId": {
      "type": "string",
      "value": "[reference('entraApp').id]"
    },
    "entraAppIdentifierUri": {
      "type": "string",
      "value": "[format('api://{0}', reference('entraApp').appId)]"
    },
    "entraAppRoleValue": {
      "type": "string",
      "value": "[variables('entraAppRoleValue')]"
    },
    "entraAppRoleId": {
      "type": "string",
      "value": "[reference('entraApp').appRoles[0].id]"
    },
    "entraAppServicePrincipalObjectId": {
      "type": "string",
      "value": "[reference('entraServicePrincipal').id]"
    }
  }
}