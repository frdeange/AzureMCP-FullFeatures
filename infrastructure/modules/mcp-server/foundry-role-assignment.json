{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "11459758727301733105"
    }
  },
  "parameters": {
    "foundryProjectResourceId": {
      "type": "string",
      "metadata": {
        "example": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.CognitiveServices/accounts/myAccount/projects/firstProject",
        "description": "Microsoft Foundry project resource ID"
      }
    },
    "entraAppServicePrincipalObjectId": {
      "type": "string",
      "metadata": {
        "description": "Entra App Service Principal Object ID (resourceId in Graph API)"
      }
    },
    "entraAppRoleId": {
      "type": "string",
      "metadata": {
        "description": "Entra App Role ID to assign"
      }
    }
  },
  "variables": {
    "resourceIdParts": "[split(parameters('foundryProjectResourceId'), '/')]",
    "projectResourceGroup": "[variables('resourceIdParts')[4]]",
    "accountName": "[variables('resourceIdParts')[8]]",
    "projectName": "[variables('resourceIdParts')[10]]"
  },
  "imports": {
    "microsoftGraphV1": {
      "provider": "MicrosoftGraph",
      "version": "1.0.0"
    }
  },
  "resources": {
    "foundryProject": {
      "existing": true,
      "type": "Microsoft.CognitiveServices/accounts/projects",
      "apiVersion": "2025-04-01-preview",
      "resourceGroup": "[variables('projectResourceGroup')]",
      "name": "[format('{0}/{1}', variables('accountName'), variables('projectName'))]"
    },
    "appRoleAssignment": {
      "import": "microsoftGraphV1",
      "type": "Microsoft.Graph/appRoleAssignedTo@v1.0",
      "properties": {
        "principalId": "[reference('foundryProject', '2025-04-01-preview', 'full').identity.principalId]",
        "resourceId": "[parameters('entraAppServicePrincipalObjectId')]",
        "appRoleId": "[parameters('entraAppRoleId')]"
      },
      "dependsOn": [
        "foundryProject"
      ]
    }
  },
  "outputs": {
    "roleAssignmentId": {
      "type": "string",
      "value": "[reference('appRoleAssignment').id]"
    },
    "foundryProjectMIPrincipalId": {
      "type": "string",
      "value": "[reference('foundryProject', '2025-04-01-preview', 'full').identity.principalId]"
    }
  }
}