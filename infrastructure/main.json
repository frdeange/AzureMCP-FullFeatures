{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.39.26.7824",
      "templateHash": "15809808767048345160"
    }
  },
  "parameters": {
    "projectName": {
      "type": "string",
      "defaultValue": "distriplatform",
      "metadata": {
        "description": "Name prefix for all resources"
      }
    },
    "aiFoundrySuffix": {
      "type": "string",
      "defaultValue": "v1",
      "metadata": {
        "description": "Suffix for AI Foundry resources (use to avoid conflicts with stuck resources)"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "swedencentral",
      "metadata": {
        "description": "Location for all resources"
      }
    },
    "resourceGroupName": {
      "type": "string",
      "defaultValue": "RG-DistriAgentPlatform",
      "metadata": {
        "description": "Resource Group name"
      }
    },
    "tags": {
      "type": "object",
      "defaultValue": {
        "project": "DistriAgentPlatform",
        "environment": "dev",
        "managedBy": "bicep"
      },
      "metadata": {
        "description": "Tags to apply to all resources"
      }
    },
    "storageAccountSku": {
      "type": "string",
      "defaultValue": "Standard_LRS",
      "allowedValues": [
        "Standard_LRS",
        "Standard_GRS",
        "Standard_ZRS",
        "Premium_LRS"
      ],
      "metadata": {
        "description": "Storage Account SKU"
      }
    },
    "cosmosDbConsistencyLevel": {
      "type": "string",
      "defaultValue": "Session",
      "allowedValues": [
        "Eventual",
        "ConsistentPrefix",
        "Session",
        "BoundedStaleness",
        "Strong"
      ],
      "metadata": {
        "description": "CosmosDB consistency level"
      }
    },
    "searchServiceSku": {
      "type": "string",
      "defaultValue": "basic",
      "allowedValues": [
        "free",
        "basic",
        "standard",
        "standard2",
        "standard3"
      ],
      "metadata": {
        "description": "Azure AI Search SKU"
      }
    },
    "createContainerAppsEnvironment": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to create Container Apps Environment"
      }
    },
    "containerRegistrySku": {
      "type": "string",
      "defaultValue": "Basic",
      "allowedValues": [
        "Basic",
        "Standard",
        "Premium"
      ],
      "metadata": {
        "description": "Azure Container Registry SKU"
      }
    },
    "createAIFoundry": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to create AI Foundry (Azure AI Hub)"
      }
    },
    "createCommunicationService": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Whether to create Azure Communication Service with Email"
      }
    },
    "deployerPrincipalId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Principal ID of the user/service principal running the deployment (for ACR push access)"
      }
    },
    "deployMcpServer": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Whether to deploy the MCP Server (Container App)"
      }
    },
    "mcpServerName": {
      "type": "string",
      "defaultValue": "[format('{0}-mcp', parameters('projectName'))]",
      "metadata": {
        "description": "Name for the MCP Server Container App"
      }
    },
    "mcpEntraAppDisplayName": {
      "type": "string",
      "defaultValue": "[format('Azure MCP Server - {0}', parameters('projectName'))]",
      "metadata": {
        "description": "Display name for the MCP Entra App"
      }
    },
    "mcpContainerImage": {
      "type": "string",
      "defaultValue": "azure-mcp-custom:latest",
      "metadata": {
        "description": "Container image name for MCP Server (e.g., azure-mcp-custom:latest)"
      }
    },
    "containerRegistryUsername": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Container Registry username (leave empty to auto-detect from ACR admin)"
      }
    },
    "containerRegistryPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Container Registry password (leave empty to auto-detect from ACR admin)"
      }
    },
    "mcpReadOnlyMode": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Enable read-only mode for MCP Server (recommended for production)"
      }
    },
    "mcpNamespaces": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "MCP Server namespaces to enable (empty = ALL)"
      }
    }
  },
  "variables": {
    "mcpRoles": {
      "contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c",
      "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
      "storageTableDataContributor": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
      "storageQueueDataContributor": "974c5e8b-45b9-4653-ba55-5f855dd0fb88",
      "keyVaultSecretsOfficer": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
      "keyVaultCertificatesOfficer": "a4417e6f-fecd-4de8-b567-7b0420556985",
      "keyVaultCryptoOfficer": "14b46e9e-c2b7-41b4-b07b-48a6ebf60603",
      "cosmosDbAccountContributor": "5bd9cd88-fe45-4216-938b-f97437e15450",
      "serviceBusDataOwner": "090c5cfd-751d-490a-894a-3ce6f1109419",
      "eventGridContributor": "1e241071-0855-49ea-94dc-649edcd759de",
      "eventHubsDataOwner": "f526a384-b230-433a-b45c-95f59c4a2dec",
      "redisCacheContributor": "e0f68234-74aa-48ed-b826-c38b57376e17",
      "appConfigurationDataOwner": "5ae67dd6-50cb-40e7-96ff-dc2bfa4b606b",
      "logAnalyticsContributor": "92aaf0da-9dab-42b6-94a3-d43ce8d16293",
      "monitoringContributor": "749f88d5-cbae-40b8-bcfc-e573ddc772fa",
      "searchServiceContributor": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
      "searchIndexDataContributor": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
      "cognitiveServicesContributor": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2024-03-01",
      "name": "[parameters('resourceGroupName')]",
      "location": "[parameters('location')]",
      "tags": "[parameters('tags')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-log-analytics",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-loganalytics', parameters('projectName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "10769587348915938368"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the Log Analytics workspace"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "retentionInDays": {
              "type": "int",
              "defaultValue": 30,
              "minValue": 30,
              "maxValue": 730,
              "metadata": {
                "description": "Retention in days"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "PerGB2018",
              "allowedValues": [
                "Free",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
              ],
              "metadata": {
                "description": "SKU for Log Analytics"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2023-09-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "sku": {
                  "name": "[parameters('sku')]"
                },
                "retentionInDays": "[parameters('retentionInDays')]",
                "features": {
                  "enableLogAccessUsingOnlyResourcePermissions": true
                },
                "workspaceCapping": {
                  "dailyQuotaGb": -1
                },
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "workspaceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Log Analytics workspace"
              },
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('name'))]"
            },
            "workspaceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Log Analytics workspace"
              },
              "value": "[parameters('name')]"
            },
            "workspaceCustomerId": {
              "type": "string",
              "metadata": {
                "description": "The customer ID (workspace ID) of the Log Analytics workspace"
              },
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('name')), '2023-09-01').customerId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-app-insights",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-appinsight', parameters('projectName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01').outputs.workspaceId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14541600669670250489"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for Application Insights"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID to link to"
              }
            },
            "applicationType": {
              "type": "string",
              "defaultValue": "web",
              "allowedValues": [
                "web",
                "other"
              ],
              "metadata": {
                "description": "Application type"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Insights/components",
              "apiVersion": "2020-02-02",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "[parameters('applicationType')]",
              "properties": {
                "Application_Type": "[parameters('applicationType')]",
                "WorkspaceResourceId": "[parameters('logAnalyticsWorkspaceId')]",
                "IngestionMode": "LogAnalytics",
                "publicNetworkAccessForIngestion": "Enabled",
                "publicNetworkAccessForQuery": "Enabled"
              }
            }
          ],
          "outputs": {
            "applicationInsightsId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of Application Insights"
              },
              "value": "[resourceId('Microsoft.Insights/components', parameters('name'))]"
            },
            "applicationInsightsName": {
              "type": "string",
              "metadata": {
                "description": "The name of Application Insights"
              },
              "value": "[parameters('name')]"
            },
            "connectionString": {
              "type": "string",
              "metadata": {
                "description": "The connection string for Application Insights"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').ConnectionString]"
            },
            "instrumentationKey": {
              "type": "string",
              "metadata": {
                "description": "The instrumentation key for Application Insights"
              },
              "value": "[reference(resourceId('Microsoft.Insights/components', parameters('name')), '2020-02-02').InstrumentationKey]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-log-analytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-storage-account",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[replace(format('{0}storage', parameters('projectName')), '-', '')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "sku": {
            "value": "[parameters('storageAccountSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "9722103728166305805"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "minLength": 3,
              "maxLength": 24,
              "metadata": {
                "description": "Name for the Storage Account (must be globally unique, lowercase, no hyphens)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Standard_LRS",
              "allowedValues": [
                "Standard_LRS",
                "Standard_GRS",
                "Standard_RAGRS",
                "Standard_ZRS",
                "Premium_LRS",
                "Premium_ZRS"
              ],
              "metadata": {
                "description": "Storage Account SKU"
              }
            },
            "kind": {
              "type": "string",
              "defaultValue": "StorageV2",
              "allowedValues": [
                "StorageV2",
                "Storage",
                "BlobStorage",
                "BlockBlobStorage",
                "FileStorage"
              ],
              "metadata": {
                "description": "Storage Account kind"
              }
            },
            "accessTier": {
              "type": "string",
              "defaultValue": "Hot",
              "allowedValues": [
                "Hot",
                "Cool"
              ],
              "metadata": {
                "description": "Access tier for blob storage"
              }
            },
            "allowBlobPublicAccess": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Allow public blob access"
              }
            },
            "minimumTlsVersion": {
              "type": "string",
              "defaultValue": "TLS1_2",
              "allowedValues": [
                "TLS1_0",
                "TLS1_1",
                "TLS1_2"
              ],
              "metadata": {
                "description": "Minimum TLS version"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Storage/storageAccounts",
              "apiVersion": "2023-05-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "kind": "[parameters('kind')]",
              "properties": {
                "accessTier": "[parameters('accessTier')]",
                "allowBlobPublicAccess": "[parameters('allowBlobPublicAccess')]",
                "minimumTlsVersion": "[parameters('minimumTlsVersion')]",
                "supportsHttpsTrafficOnly": true,
                "encryption": {
                  "services": {
                    "blob": {
                      "enabled": true
                    },
                    "file": {
                      "enabled": true
                    }
                  },
                  "keySource": "Microsoft.Storage"
                },
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            },
            {
              "type": "Microsoft.Storage/storageAccounts/blobServices",
              "apiVersion": "2023-05-01",
              "name": "[format('{0}/{1}', parameters('name'), 'default')]",
              "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
              ]
            }
          ],
          "outputs": {
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Storage Account"
              },
              "value": "[resourceId('Microsoft.Storage/storageAccounts', parameters('name'))]"
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Storage Account"
              },
              "value": "[parameters('name')]"
            },
            "blobEndpoint": {
              "type": "string",
              "metadata": {
                "description": "The primary endpoint for blob storage"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-05-01').primaryEndpoints.blob]"
            },
            "fileEndpoint": {
              "type": "string",
              "metadata": {
                "description": "The primary endpoint for file storage"
              },
              "value": "[reference(resourceId('Microsoft.Storage/storageAccounts', parameters('name')), '2023-05-01').primaryEndpoints.file]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-cosmos-db",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-cosmos', parameters('projectName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "consistencyLevel": {
            "value": "[parameters('cosmosDbConsistencyLevel')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12904596156694574120"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the Cosmos DB account"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "consistencyLevel": {
              "type": "string",
              "defaultValue": "Session",
              "allowedValues": [
                "Eventual",
                "ConsistentPrefix",
                "Session",
                "BoundedStaleness",
                "Strong"
              ],
              "metadata": {
                "description": "Consistency level for the Cosmos DB account"
              }
            },
            "enableFreeTier": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable free tier (only one per subscription)"
              }
            },
            "enableAutomaticFailover": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable automatic failover"
              }
            },
            "enableMultipleWriteLocations": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable multiple write locations"
              }
            },
            "maxStalenessPrefix": {
              "type": "int",
              "defaultValue": 100000,
              "metadata": {
                "description": "Max staleness prefix for BoundedStaleness consistency"
              }
            },
            "maxIntervalInSeconds": {
              "type": "int",
              "defaultValue": 300,
              "metadata": {
                "description": "Max interval in seconds for BoundedStaleness consistency"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2024-05-15",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "enableFreeTier": "[parameters('enableFreeTier')]",
                "enableAutomaticFailover": "[parameters('enableAutomaticFailover')]",
                "enableMultipleWriteLocations": "[parameters('enableMultipleWriteLocations')]",
                "consistencyPolicy": "[if(equals(parameters('consistencyLevel'), 'BoundedStaleness'), createObject('defaultConsistencyLevel', parameters('consistencyLevel'), 'maxStalenessPrefix', parameters('maxStalenessPrefix'), 'maxIntervalInSeconds', parameters('maxIntervalInSeconds')), createObject('defaultConsistencyLevel', parameters('consistencyLevel')))]",
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "backupPolicy": {
                  "type": "Continuous",
                  "continuousModeProperties": {
                    "tier": "Continuous7Days"
                  }
                },
                "publicNetworkAccess": "Enabled"
              }
            }
          ],
          "outputs": {
            "accountId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Cosmos DB account"
              },
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name'))]"
            },
            "accountName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Cosmos DB account"
              },
              "value": "[parameters('name')]"
            },
            "endpoint": {
              "type": "string",
              "metadata": {
                "description": "The endpoint for the Cosmos DB account"
              },
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('name')), '2024-05-15').documentEndpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-ai-search",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-search', parameters('projectName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "sku": {
            "value": "[parameters('searchServiceSku')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17847318762595342207"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the Azure AI Search service"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "basic",
              "allowedValues": [
                "free",
                "basic",
                "standard",
                "standard2",
                "standard3",
                "storage_optimized_l1",
                "storage_optimized_l2"
              ],
              "metadata": {
                "description": "SKU for the Search service"
              }
            },
            "replicaCount": {
              "type": "int",
              "defaultValue": 1,
              "minValue": 1,
              "maxValue": 12,
              "metadata": {
                "description": "Number of replicas"
              }
            },
            "partitionCount": {
              "type": "int",
              "defaultValue": 1,
              "allowedValues": [
                1,
                2,
                3,
                4,
                6,
                12
              ],
              "metadata": {
                "description": "Number of partitions"
              }
            },
            "hostingMode": {
              "type": "string",
              "defaultValue": "default",
              "allowedValues": [
                "default",
                "highDensity"
              ],
              "metadata": {
                "description": "Hosting mode"
              }
            },
            "publicNetworkAccess": {
              "type": "string",
              "defaultValue": "enabled",
              "allowedValues": [
                "enabled",
                "disabled"
              ],
              "metadata": {
                "description": "Public network access"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Search/searchServices",
              "apiVersion": "2024-06-01-preview",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "replicaCount": "[parameters('replicaCount')]",
                "partitionCount": "[parameters('partitionCount')]",
                "hostingMode": "[parameters('hostingMode')]",
                "publicNetworkAccess": "[parameters('publicNetworkAccess')]",
                "semanticSearch": "[if(not(equals(parameters('sku'), 'free')), 'standard', 'disabled')]",
                "authOptions": {
                  "aadOrApiKey": {
                    "aadAuthFailureMode": "http401WithBearerChallenge"
                  }
                }
              }
            }
          ],
          "outputs": {
            "searchServiceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Search service"
              },
              "value": "[resourceId('Microsoft.Search/searchServices', parameters('name'))]"
            },
            "searchServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Search service"
              },
              "value": "[parameters('name')]"
            },
            "endpoint": {
              "type": "string",
              "metadata": {
                "description": "The endpoint for the Search service"
              },
              "value": "[format('https://{0}.search.windows.net', parameters('name'))]"
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the Search service managed identity"
              },
              "value": "[reference(resourceId('Microsoft.Search/searchServices', parameters('name')), '2024-06-01-preview', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('createContainerAppsEnvironment')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-container-apps-env",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-aca-env', parameters('projectName'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "logAnalyticsWorkspaceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01').outputs.workspaceId.value]"
          },
          "logAnalyticsWorkspaceCustomerId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01').outputs.workspaceCustomerId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12747290418427208897"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the Container Apps Environment"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace ID"
              }
            },
            "logAnalyticsWorkspaceCustomerId": {
              "type": "string",
              "metadata": {
                "description": "Log Analytics Workspace Customer ID"
              }
            },
            "zoneRedundant": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable zone redundancy"
              }
            },
            "workloadProfileType": {
              "type": "string",
              "defaultValue": "Consumption",
              "allowedValues": [
                "Consumption",
                "D4",
                "D8",
                "D16",
                "D32",
                "E4",
                "E8",
                "E16",
                "E32"
              ],
              "metadata": {
                "description": "Workload profile type"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[parameters('logAnalyticsWorkspaceCustomerId')]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', last(split(parameters('logAnalyticsWorkspaceId'), '/'))), '2023-09-01').primarySharedKey]"
                  }
                },
                "zoneRedundant": "[parameters('zoneRedundant')]",
                "workloadProfiles": [
                  {
                    "name": "Consumption",
                    "workloadProfileType": "[parameters('workloadProfileType')]"
                  }
                ]
              }
            }
          ],
          "outputs": {
            "environmentId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Container Apps Environment"
              },
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('name'))]"
            },
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Apps Environment"
              },
              "value": "[parameters('name')]"
            },
            "defaultDomain": {
              "type": "string",
              "metadata": {
                "description": "The default domain for the Container Apps Environment"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-03-01').defaultDomain]"
            },
            "staticIp": {
              "type": "string",
              "metadata": {
                "description": "The static IP of the Container Apps Environment"
              },
              "value": "[reference(resourceId('Microsoft.App/managedEnvironments', parameters('name')), '2024-03-01').staticIp]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-log-analytics')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('createAIFoundry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-key-vault",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}kv', replace(parameters('projectName'), '-', ''))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "6613883611166500422"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the Key Vault (must be globally unique)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "enableRbacAuthorization": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable RBAC authorization (recommended)"
              }
            },
            "enableSoftDelete": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable soft delete"
              }
            },
            "softDeleteRetentionDays": {
              "type": "int",
              "defaultValue": 90,
              "minValue": 7,
              "maxValue": 90,
              "metadata": {
                "description": "Soft delete retention in days"
              }
            },
            "enablePurgeProtection": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable purge protection (prevents permanent deletion)"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "standard",
              "allowedValues": [
                "standard",
                "premium"
              ],
              "metadata": {
                "description": "SKU for the Key Vault"
              }
            },
            "publicNetworkAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Allow public network access"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.KeyVault/vaults",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "tenantId": "[subscription().tenantId]",
                "sku": {
                  "family": "A",
                  "name": "[parameters('sku')]"
                },
                "enabledForDeployment": false,
                "enabledForDiskEncryption": false,
                "enabledForTemplateDeployment": true,
                "enableSoftDelete": "[parameters('enableSoftDelete')]",
                "softDeleteRetentionInDays": "[parameters('softDeleteRetentionDays')]",
                "enablePurgeProtection": "[if(parameters('enablePurgeProtection'), true(), null())]",
                "enableRbacAuthorization": "[parameters('enableRbacAuthorization')]",
                "publicNetworkAccess": "[if(parameters('publicNetworkAccess'), 'Enabled', 'Disabled')]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "bypass": "AzureServices"
                }
              }
            }
          ],
          "outputs": {
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Key Vault"
              },
              "value": "[resourceId('Microsoft.KeyVault/vaults', parameters('name'))]"
            },
            "keyVaultName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Key Vault"
              },
              "value": "[parameters('name')]"
            },
            "keyVaultUri": {
              "type": "string",
              "metadata": {
                "description": "The URI of the Key Vault"
              },
              "value": "[reference(resourceId('Microsoft.KeyVault/vaults', parameters('name')), '2023-07-01').vaultUri]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-container-registry",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}acr', replace(parameters('projectName'), '-', ''))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "sku": {
            "value": "[parameters('containerRegistrySku')]"
          },
          "adminUserEnabled": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3489269815967956882"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the Container Registry (must be globally unique, alphanumeric only)"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "allowedValues": [
                "Basic",
                "Standard",
                "Premium"
              ],
              "metadata": {
                "description": "SKU for the Container Registry"
              }
            },
            "adminUserEnabled": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable admin user (needed for some scenarios like ACA without managed identity)"
              }
            },
            "publicNetworkAccess": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable public network access"
              }
            },
            "zoneRedundancy": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Enable zone redundancy (Premium SKU only)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "adminUserEnabled": "[parameters('adminUserEnabled')]",
                "publicNetworkAccess": "[if(parameters('publicNetworkAccess'), 'Enabled', 'Disabled')]",
                "zoneRedundancy": "[if(and(equals(parameters('sku'), 'Premium'), parameters('zoneRedundancy')), 'Enabled', 'Disabled')]",
                "policies": {
                  "retentionPolicy": {
                    "status": "[if(equals(parameters('sku'), 'Premium'), 'enabled', 'disabled')]",
                    "days": 7
                  }
                }
              }
            }
          ],
          "outputs": {
            "registryId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Container Registry"
              },
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "registryName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Container Registry"
              },
              "value": "[parameters('name')]"
            },
            "loginServer": {
              "type": "string",
              "metadata": {
                "description": "The login server URL"
              },
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').loginServer]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('createAIFoundry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-ai-foundry",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "hubName": {
            "value": "[format('{0}-aifoundry-{1}', parameters('projectName'), parameters('aiFoundrySuffix'))]"
          },
          "projectName": {
            "value": "[format('{0}-aiproject-{1}', parameters('projectName'), parameters('aiFoundrySuffix'))]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "storageAccountId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "15696968639453821137"
            }
          },
          "parameters": {
            "hubName": {
              "type": "string",
              "metadata": {
                "description": "Name for the AI Foundry Account"
              }
            },
            "projectName": {
              "type": "string",
              "metadata": {
                "description": "Name for the AI Project"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account ID for user-owned storage"
              }
            },
            "allowProjectManagement": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Allow project management on the AI Foundry account"
              }
            },
            "disableLocalAuth": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Disable local authentication (recommended for security)"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts",
              "apiVersion": "2025-06-01",
              "name": "[parameters('hubName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "kind": "AIServices",
              "sku": {
                "name": "S0"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "apiProperties": {},
                "customSubDomainName": "[toLower(parameters('hubName'))]",
                "networkAcls": {
                  "defaultAction": "Allow",
                  "virtualNetworkRules": [],
                  "ipRules": []
                },
                "userOwnedStorage": [
                  {
                    "resourceId": "[parameters('storageAccountId')]"
                  }
                ],
                "allowProjectManagement": "[parameters('allowProjectManagement')]",
                "defaultProject": "[parameters('projectName')]",
                "associatedProjects": [
                  "[parameters('projectName')]"
                ],
                "publicNetworkAccess": "Enabled",
                "disableLocalAuth": "[parameters('disableLocalAuth')]"
              }
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('hubName'), parameters('projectName'))]",
              "location": "[parameters('location')]",
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "description": "Default project created with the resource",
                "displayName": "[parameters('projectName')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('hubName'))]"
              ]
            },
            {
              "type": "Microsoft.CognitiveServices/accounts/defenderForAISettings",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('hubName'), 'Default')]",
              "properties": {
                "state": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts', parameters('hubName'))]"
              ]
            }
          ],
          "outputs": {
            "aiHubId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the AI Foundry Account"
              },
              "value": "[resourceId('Microsoft.CognitiveServices/accounts', parameters('hubName'))]"
            },
            "aiHubName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Account"
              },
              "value": "[parameters('hubName')]"
            },
            "aiProjectId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the AI Foundry Project"
              },
              "value": "[resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('hubName'), parameters('projectName'))]"
            },
            "aiProjectName": {
              "type": "string",
              "metadata": {
                "description": "The name of the AI Foundry Project"
              },
              "value": "[parameters('projectName')]"
            },
            "aiHubPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the AI Foundry Account managed identity"
              },
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('hubName')), '2025-06-01', 'full').identity.principalId]"
            },
            "aiProjectPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "The principal ID of the AI Foundry Project managed identity"
              },
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts/projects', parameters('hubName'), parameters('projectName')), '2025-06-01', 'full').identity.principalId]"
            },
            "aiFoundryEndpoint": {
              "type": "string",
              "metadata": {
                "description": "The endpoint of the AI Foundry Account"
              },
              "value": "[reference(resourceId('Microsoft.CognitiveServices/accounts', parameters('hubName')), '2025-06-01').endpoint]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account')]"
      ]
    },
    {
      "condition": "[parameters('createAIFoundry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-rbac-assignments",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiHubPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiHubPrincipalId.value]"
          },
          "aiProjectPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiProjectPrincipalId.value]"
          },
          "storageAccountId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountId.value]"
          },
          "containerRegistryId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-registry'), '2025-04-01').outputs.registryId.value]"
          },
          "cosmosDbAccountId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db'), '2025-04-01').outputs.accountId.value]"
          },
          "aiSearchServiceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search'), '2025-04-01').outputs.searchServiceId.value]"
          },
          "aiSearchPrincipalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search'), '2025-04-01').outputs.principalId.value]"
          },
          "keyVaultId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-key-vault'), '2025-04-01').outputs.keyVaultId.value]"
          },
          "communicationServiceId": "[if(parameters('createCommunicationService'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-communication-service'), '2025-04-01').outputs.communicationServiceId.value), createObject('value', ''))]",
          "deployerPrincipalId": {
            "value": "[parameters('deployerPrincipalId')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "12832530372430230577"
            }
          },
          "parameters": {
            "aiHubPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Principal ID of the AI Hub managed identity"
              }
            },
            "aiProjectPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Principal ID of the AI Project managed identity"
              }
            },
            "aiSearchPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Principal ID of the AI Search managed identity"
              }
            },
            "deployerPrincipalId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Principal ID of the deployer (user running the deployment)"
              }
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account ID"
              }
            },
            "containerRegistryId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Container Registry ID"
              }
            },
            "cosmosDbAccountId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Cosmos DB Account ID"
              }
            },
            "aiSearchServiceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "AI Search Service ID"
              }
            },
            "keyVaultId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Key Vault ID"
              }
            },
            "communicationServiceId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Communication Service ID"
              }
            }
          },
          "variables": {
            "roles": {
              "storageBlobDataContributor": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
              "storageBlobDataReader": "2a2b9908-6ea1-4ae2-8e65-a410df84e7d1",
              "storageFileDataPrivilegedContributor": "69566ab7-960f-475b-8e7c-b3118f30c6bd",
              "storageTableDataContributor": "0a9a7e1f-b9d0-4cc4-a60d-0319b160aaa3",
              "acrPull": "7f951dda-4ed3-4680-a7ca-43fe172d538d",
              "acrPush": "8311e382-0749-4cb8-b61a-304f252e45ec",
              "cosmosDbAccountReader": "fbdf93bf-df7d-467e-a4d2-9458aa1360c8",
              "documentDbAccountContributor": "5bd9cd88-fe45-4216-938b-f97437e15450",
              "searchIndexDataContributor": "8ebe5a00-799e-43f5-93ac-243d3dce84a7",
              "searchIndexDataReader": "1407120a-92aa-4202-b7e9-c0e197c71c8f",
              "searchServiceContributor": "7ca78c08-252a-4471-8644-bb5ff32d4ba0",
              "keyVaultSecretsUser": "4633458b-17de-408a-b874-0445c86b69e6",
              "keyVaultSecretsOfficer": "b86a8fe4-44ce-4948-aee5-eccb2c155cd7",
              "keyVaultCryptoUser": "12338af0-0e69-4776-bea7-57ae8d297424",
              "keyVaultAdministrator": "00482a5a-887f-4fb3-b363-3b7fe8e74483",
              "cognitiveServicesUser": "a97b65f3-24c7-4388-baec-2e87135dc908",
              "cognitiveServicesContributor": "25fbc0a9-bd7c-42a3-aa1a-3b75d497ee68",
              "reader": "acdd72a7-3385-48ef-bd42-f606fba81ae7",
              "contributor": "b24988ac-6180-42a0-ab88-20f7382dd24c"
            }
          },
          "resources": [
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('storageAccountId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('aiHubPrincipalId'), variables('roles').storageBlobDataContributor)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('storageAccountId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('aiHubPrincipalId'), variables('roles').storageFileDataPrivilegedContributor)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageFileDataPrivilegedContributor)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('storageAccountId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('aiProjectPrincipalId'), variables('roles').storageBlobDataContributor)]",
              "properties": {
                "principalId": "[parameters('aiProjectPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataContributor)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', last(split(parameters('containerRegistryId'), '/')))]",
              "name": "[guid(parameters('containerRegistryId'), parameters('aiHubPrincipalId'), variables('roles').acrPush)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').acrPush)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', last(split(parameters('containerRegistryId'), '/')))]",
              "name": "[guid(parameters('containerRegistryId'), parameters('aiHubPrincipalId'), variables('roles').reader)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').reader)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', last(split(parameters('containerRegistryId'), '/')))]",
              "name": "[guid(parameters('containerRegistryId'), parameters('aiProjectPrincipalId'), variables('roles').acrPull)]",
              "properties": {
                "principalId": "[parameters('aiProjectPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').acrPull)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', last(split(parameters('containerRegistryId'), '/')))]",
              "name": "[guid(parameters('containerRegistryId'), parameters('aiProjectPrincipalId'), variables('roles').reader)]",
              "properties": {
                "principalId": "[parameters('aiProjectPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').reader)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('keyVaultId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', last(split(parameters('keyVaultId'), '/')))]",
              "name": "[guid(parameters('keyVaultId'), parameters('aiHubPrincipalId'), variables('roles').keyVaultSecretsOfficer)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsOfficer)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('keyVaultId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', last(split(parameters('keyVaultId'), '/')))]",
              "name": "[guid(parameters('keyVaultId'), parameters('aiProjectPrincipalId'), variables('roles').keyVaultSecretsUser)]",
              "properties": {
                "principalId": "[parameters('aiProjectPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultSecretsUser)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('aiSearchServiceId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', last(split(parameters('aiSearchServiceId'), '/')))]",
              "name": "[guid(parameters('aiSearchServiceId'), parameters('aiHubPrincipalId'), variables('roles').searchIndexDataContributor)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchIndexDataContributor)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('aiSearchServiceId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Search/searchServices/{0}', last(split(parameters('aiSearchServiceId'), '/')))]",
              "name": "[guid(parameters('aiSearchServiceId'), parameters('aiProjectPrincipalId'), variables('roles').searchIndexDataReader)]",
              "properties": {
                "principalId": "[parameters('aiProjectPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').searchIndexDataReader)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('cosmosDbAccountId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.DocumentDB/databaseAccounts/{0}', last(split(parameters('cosmosDbAccountId'), '/')))]",
              "name": "[guid(parameters('cosmosDbAccountId'), parameters('aiHubPrincipalId'), variables('roles').documentDbAccountContributor)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').documentDbAccountContributor)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('communicationServiceId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Communication/communicationServices/{0}', last(split(parameters('communicationServiceId'), '/')))]",
              "name": "[guid(parameters('communicationServiceId'), parameters('aiHubPrincipalId'), variables('roles').contributor)]",
              "properties": {
                "principalId": "[parameters('aiHubPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').contributor)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('communicationServiceId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Communication/communicationServices/{0}', last(split(parameters('communicationServiceId'), '/')))]",
              "name": "[guid(parameters('communicationServiceId'), parameters('aiProjectPrincipalId'), variables('roles').contributor)]",
              "properties": {
                "principalId": "[parameters('aiProjectPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').contributor)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('aiSearchPrincipalId'))), not(empty(parameters('storageAccountId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.Storage/storageAccounts/{0}', last(split(parameters('storageAccountId'), '/')))]",
              "name": "[guid(parameters('storageAccountId'), parameters('aiSearchPrincipalId'), variables('roles').storageBlobDataReader)]",
              "properties": {
                "principalId": "[parameters('aiSearchPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').storageBlobDataReader)]",
                "principalType": "ServicePrincipal"
              }
            },
            {
              "condition": "[and(not(empty(parameters('deployerPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', last(split(parameters('containerRegistryId'), '/')))]",
              "name": "[guid(parameters('containerRegistryId'), parameters('deployerPrincipalId'), variables('roles').acrPush)]",
              "properties": {
                "principalId": "[parameters('deployerPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').acrPush)]",
                "principalType": "User"
              }
            },
            {
              "condition": "[and(not(empty(parameters('deployerPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', last(split(parameters('containerRegistryId'), '/')))]",
              "name": "[guid(parameters('containerRegistryId'), parameters('deployerPrincipalId'), variables('roles').reader)]",
              "properties": {
                "principalId": "[parameters('deployerPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').reader)]",
                "principalType": "User"
              }
            },
            {
              "condition": "[and(not(empty(parameters('deployerPrincipalId'))), not(empty(parameters('keyVaultId'))))]",
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "scope": "[format('Microsoft.KeyVault/vaults/{0}', last(split(parameters('keyVaultId'), '/')))]",
              "name": "[guid(parameters('keyVaultId'), parameters('deployerPrincipalId'), variables('roles').keyVaultAdministrator)]",
              "properties": {
                "principalId": "[parameters('deployerPrincipalId')]",
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', variables('roles').keyVaultAdministrator)]",
                "principalType": "User"
              }
            }
          ],
          "outputs": {
            "roleAssignmentsSummary": {
              "type": "object",
              "metadata": {
                "description": "Summary of role assignments created"
              },
              "value": {
                "aiHubToStorage": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('storageAccountId'))))]",
                "aiHubToAcr": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
                "aiHubToKeyVault": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('keyVaultId'))))]",
                "aiHubToSearch": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('aiSearchServiceId'))))]",
                "aiHubToCosmos": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('cosmosDbAccountId'))))]",
                "aiHubToCommunication": "[and(not(empty(parameters('aiHubPrincipalId'))), not(empty(parameters('communicationServiceId'))))]",
                "aiProjectToStorage": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('storageAccountId'))))]",
                "aiProjectToAcr": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
                "aiProjectToKeyVault": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('keyVaultId'))))]",
                "aiProjectToSearch": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('aiSearchServiceId'))))]",
                "aiProjectToCommunication": "[and(not(empty(parameters('aiProjectPrincipalId'))), not(empty(parameters('communicationServiceId'))))]",
                "aiSearchToStorage": "[and(not(empty(parameters('aiSearchPrincipalId'))), not(empty(parameters('storageAccountId'))))]",
                "deployerToAcr": "[and(not(empty(parameters('deployerPrincipalId'))), not(empty(parameters('containerRegistryId'))))]",
                "deployerToKeyVault": "[and(not(empty(parameters('deployerPrincipalId'))), not(empty(parameters('keyVaultId'))))]"
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-communication-service')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-registry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-key-vault')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account')]"
      ]
    },
    {
      "condition": "[parameters('createAIFoundry')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-ai-foundry-connections",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "aiFoundryAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiHubName.value]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "storageAccountId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountId.value]"
          },
          "storageAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountName.value]"
          },
          "keyVaultId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-key-vault'), '2025-04-01').outputs.keyVaultId.value]"
          },
          "applicationInsightsId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01').outputs.applicationInsightsId.value]"
          },
          "applicationInsightsName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01').outputs.applicationInsightsName.value]"
          },
          "applicationInsightsKey": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01').outputs.instrumentationKey.value]"
          },
          "aiSearchId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search'), '2025-04-01').outputs.searchServiceId.value]"
          },
          "aiSearchName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search'), '2025-04-01').outputs.searchServiceName.value]"
          },
          "cosmosDbId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db'), '2025-04-01').outputs.accountId.value]"
          },
          "cosmosDbName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db'), '2025-04-01').outputs.accountName.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "2122195698285590794"
            }
          },
          "parameters": {
            "aiFoundryAccountName": {
              "type": "string",
              "metadata": {
                "description": "AI Foundry Account name"
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resource"
              }
            },
            "storageAccountId": {
              "type": "string",
              "metadata": {
                "description": "Storage Account ID"
              }
            },
            "storageAccountName": {
              "type": "string",
              "metadata": {
                "description": "Storage Account Name"
              }
            },
            "keyVaultId": {
              "type": "string",
              "metadata": {
                "description": "Key Vault ID"
              }
            },
            "applicationInsightsId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights ID (optional)"
              }
            },
            "applicationInsightsName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights Name"
              }
            },
            "applicationInsightsKey": {
              "type": "securestring",
              "defaultValue": "",
              "metadata": {
                "description": "Application Insights Instrumentation Key"
              }
            },
            "aiSearchId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "AI Search ID (optional)"
              }
            },
            "aiSearchName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "AI Search Name"
              }
            },
            "cosmosDbId": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "CosmosDB Account ID (optional)"
              }
            },
            "cosmosDbName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "CosmosDB Account Name"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.CognitiveServices/accounts/connections",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('aiFoundryAccountName'), format('{0}-keyvault', parameters('aiFoundryAccountName')))]",
              "properties": {
                "authType": "AccountManagedIdentity",
                "category": "AzureKeyVault",
                "target": "[parameters('keyVaultId')]",
                "useWorkspaceManagedIdentity": true,
                "isSharedToAll": true,
                "sharedUserList": [],
                "peRequirement": "NotRequired",
                "peStatus": "NotApplicable",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[parameters('keyVaultId')]",
                  "location": "[parameters('location')]"
                }
              }
            },
            {
              "condition": "[not(empty(parameters('storageAccountId')))]",
              "type": "Microsoft.CognitiveServices/accounts/connections",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('aiFoundryAccountName'), format('{0}-storage', parameters('aiFoundryAccountName')))]",
              "properties": {
                "authType": "AAD",
                "category": "AzureStorageAccount",
                "target": "[format('https://{0}.blob.{1}', parameters('storageAccountName'), environment().suffixes.storage)]",
                "useWorkspaceManagedIdentity": false,
                "isSharedToAll": true,
                "sharedUserList": [],
                "peRequirement": "NotRequired",
                "peStatus": "NotApplicable",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[parameters('storageAccountId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/connections', parameters('aiFoundryAccountName'), format('{0}-keyvault', parameters('aiFoundryAccountName')))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('aiSearchId')))]",
              "type": "Microsoft.CognitiveServices/accounts/connections",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('aiFoundryAccountName'), format('{0}-aisearch', parameters('aiFoundryAccountName')))]",
              "properties": {
                "authType": "AAD",
                "category": "CognitiveSearch",
                "target": "[format('https://{0}.search.windows.net', parameters('aiSearchName'))]",
                "useWorkspaceManagedIdentity": false,
                "isSharedToAll": true,
                "sharedUserList": [],
                "peRequirement": "NotRequired",
                "peStatus": "NotApplicable",
                "metadata": {
                  "ResourceId": "[parameters('aiSearchId')]",
                  "location": "[parameters('location')]",
                  "ApiVersion": "2024-05-01-preview",
                  "DeploymentApiVersion": "2023-11-01"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/connections', parameters('aiFoundryAccountName'), format('{0}-storage', parameters('aiFoundryAccountName')))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('cosmosDbId')))]",
              "type": "Microsoft.CognitiveServices/accounts/connections",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('aiFoundryAccountName'), format('{0}-cosmosdb', parameters('aiFoundryAccountName')))]",
              "properties": {
                "authType": "AAD",
                "category": "CosmosDb",
                "target": "[format('https://{0}.documents.azure.com:443/', parameters('cosmosDbName'))]",
                "useWorkspaceManagedIdentity": false,
                "isSharedToAll": true,
                "sharedUserList": [],
                "peRequirement": "NotRequired",
                "peStatus": "NotApplicable",
                "metadata": {
                  "ApiType": "Azure",
                  "ResourceId": "[parameters('cosmosDbId')]",
                  "location": "[parameters('location')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/connections', parameters('aiFoundryAccountName'), format('{0}-aisearch', parameters('aiFoundryAccountName')))]"
              ]
            },
            {
              "condition": "[not(empty(parameters('applicationInsightsId')))]",
              "type": "Microsoft.CognitiveServices/accounts/connections",
              "apiVersion": "2025-06-01",
              "name": "[format('{0}/{1}', parameters('aiFoundryAccountName'), format('{0}-appinsights', parameters('aiFoundryAccountName')))]",
              "properties": {
                "authType": "ApiKey",
                "category": "AppInsights",
                "target": "[parameters('applicationInsightsId')]",
                "useWorkspaceManagedIdentity": false,
                "isSharedToAll": true,
                "credentials": {
                  "key": "[parameters('applicationInsightsKey')]"
                },
                "sharedUserList": [],
                "peRequirement": "NotRequired",
                "peStatus": "NotApplicable",
                "metadata": {
                  "displayName": "[parameters('applicationInsightsName')]",
                  "ApiType": "Azure",
                  "ResourceId": "[parameters('applicationInsightsId')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.CognitiveServices/accounts/connections', parameters('aiFoundryAccountName'), format('{0}-cosmosdb', parameters('aiFoundryAccountName')))]"
              ]
            }
          ],
          "outputs": {
            "connectionsCreated": {
              "type": "int",
              "metadata": {
                "description": "Number of connections created"
              },
              "value": 5
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-key-vault')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-rbac-assignments')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account')]"
      ]
    },
    {
      "condition": "[parameters('createCommunicationService')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-communication-service",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[format('{0}-comm', parameters('projectName'))]"
          },
          "location": {
            "value": "global"
          },
          "tags": {
            "value": "[parameters('tags')]"
          },
          "dataLocation": {
            "value": "Europe"
          },
          "createEmailService": {
            "value": true
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3667458514960447325"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name for the Communication Service"
              }
            },
            "location": {
              "type": "string",
              "defaultValue": "global",
              "metadata": {
                "description": "Location for the resource (Communication Services is global)"
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply"
              }
            },
            "dataLocation": {
              "type": "string",
              "defaultValue": "Europe",
              "allowedValues": [
                "United States",
                "Europe",
                "UK",
                "Japan",
                "Australia",
                "Brazil",
                "Canada",
                "France",
                "Germany",
                "India",
                "Korea",
                "Norway",
                "Switzerland",
                "UAE"
              ],
              "metadata": {
                "description": "Data location for the Communication Service"
              }
            },
            "createEmailService": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Whether to create Email Communication Service"
              }
            }
          },
          "resources": [
            {
              "condition": "[parameters('createEmailService')]",
              "type": "Microsoft.Communication/emailServices",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}-email', parameters('name'))]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]"
              }
            },
            {
              "condition": "[parameters('createEmailService')]",
              "type": "Microsoft.Communication/emailServices/domains",
              "apiVersion": "2023-04-01",
              "name": "[format('{0}/{1}', format('{0}-email', parameters('name')), 'AzureManagedDomain')]",
              "location": "[parameters('location')]",
              "properties": {
                "domainManagement": "AzureManaged",
                "userEngagementTracking": "Disabled"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices', format('{0}-email', parameters('name')))]"
              ]
            },
            {
              "type": "Microsoft.Communication/communicationServices",
              "apiVersion": "2023-04-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "dataLocation": "[parameters('dataLocation')]",
                "linkedDomains": "[if(parameters('createEmailService'), createArray(resourceId('Microsoft.Communication/emailServices/domains', format('{0}-email', parameters('name')), 'AzureManagedDomain')), createArray())]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Communication/emailServices/domains', format('{0}-email', parameters('name')), 'AzureManagedDomain')]"
              ]
            }
          ],
          "outputs": {
            "communicationServiceId": {
              "type": "string",
              "metadata": {
                "description": "The resource ID of the Communication Service"
              },
              "value": "[resourceId('Microsoft.Communication/communicationServices', parameters('name'))]"
            },
            "communicationServiceName": {
              "type": "string",
              "metadata": {
                "description": "The name of the Communication Service"
              },
              "value": "[parameters('name')]"
            },
            "hostname": {
              "type": "string",
              "metadata": {
                "description": "The hostname of the Communication Service"
              },
              "value": "[reference(resourceId('Microsoft.Communication/communicationServices', parameters('name')), '2023-04-01').hostName]"
            },
            "emailServiceId": {
              "type": "string",
              "metadata": {
                "description": "The Email Service ID"
              },
              "value": "[if(parameters('createEmailService'), resourceId('Microsoft.Communication/emailServices', format('{0}-email', parameters('name'))), '')]"
            },
            "emailServiceName": {
              "type": "string",
              "metadata": {
                "description": "The Email Service name"
              },
              "value": "[if(parameters('createEmailService'), format('{0}-email', parameters('name')), '')]"
            },
            "emailDomainId": {
              "type": "string",
              "metadata": {
                "description": "The Email Domain ID"
              },
              "value": "[if(parameters('createEmailService'), resourceId('Microsoft.Communication/emailServices/domains', format('{0}-email', parameters('name')), 'AzureManagedDomain'), '')]"
            },
            "azureManagedDomainMailFrom": {
              "type": "string",
              "metadata": {
                "description": "The Azure Managed Domain sender address (available after deployment)"
              },
              "value": "[if(parameters('createEmailService'), reference(resourceId('Microsoft.Communication/emailServices/domains', format('{0}-email', parameters('name')), 'AzureManagedDomain'), '2023-04-01').mailFromSenderDomain, '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-mcp-entra-app",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "entraAppDisplayName": {
            "value": "[parameters('mcpEntraAppDisplayName')]"
          },
          "entraAppUniqueName": {
            "value": "[format('{0}-{1}', replace(toLower(parameters('mcpEntraAppDisplayName')), ' ', '-'), uniqueString(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))))]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "3943911509924351084"
            }
          },
          "parameters": {
            "entraAppDisplayName": {
              "type": "string",
              "metadata": {
                "description": "Display name for the Entra Application"
              }
            },
            "entraAppUniqueName": {
              "type": "string",
              "metadata": {
                "description": "Unique name for the Entra Application"
              }
            }
          },
          "variables": {
            "entraAppRoleValue": "Mcp.Tools.ReadWrite.All",
            "entraAppRoleId": "[guid(subscription().id, variables('entraAppRoleValue'))]",
            "entraAppRoleDisplayName": "Azure MCP Tools ReadWrite All",
            "entraAppRoleDescription": "Application permission for Azure MCP tool calls"
          },
          "imports": {
            "microsoftGraphV1": {
              "provider": "MicrosoftGraph",
              "version": "1.0.0"
            }
          },
          "resources": {
            "entraApp": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/applications@v1.0",
              "properties": {
                "uniqueName": "[parameters('entraAppUniqueName')]",
                "displayName": "[parameters('entraAppDisplayName')]",
                "appRoles": [
                  {
                    "id": "[variables('entraAppRoleId')]",
                    "displayName": "[variables('entraAppRoleDisplayName')]",
                    "description": "[variables('entraAppRoleDescription')]",
                    "value": "[variables('entraAppRoleValue')]",
                    "isEnabled": true,
                    "allowedMemberTypes": [
                      "Application"
                    ]
                  }
                ]
              }
            },
            "entraAppUpdate": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/applications@v1.0",
              "properties": {
                "uniqueName": "[parameters('entraAppUniqueName')]",
                "displayName": "[parameters('entraAppDisplayName')]",
                "appRoles": "[reference('entraApp').appRoles]",
                "identifierUris": [
                  "[format('api://{0}', reference('entraApp').appId)]"
                ]
              },
              "dependsOn": [
                "entraApp"
              ]
            },
            "entraServicePrincipal": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/servicePrincipals@v1.0",
              "properties": {
                "appId": "[reference('entraApp').appId]"
              },
              "dependsOn": [
                "entraApp"
              ]
            }
          },
          "outputs": {
            "entraAppClientId": {
              "type": "string",
              "value": "[reference('entraApp').appId]"
            },
            "entraAppObjectId": {
              "type": "string",
              "value": "[reference('entraApp').id]"
            },
            "entraAppIdentifierUri": {
              "type": "string",
              "value": "[format('api://{0}', reference('entraApp').appId)]"
            },
            "entraAppRoleValue": {
              "type": "string",
              "value": "[variables('entraAppRoleValue')]"
            },
            "entraAppRoleId": {
              "type": "string",
              "value": "[reference('entraApp').appRoles[0].id]"
            },
            "entraAppServicePrincipalObjectId": {
              "type": "string",
              "value": "[reference('entraServicePrincipal').id]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "deploy-mcp-container-app",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('mcpServerName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "appInsightsConnectionString": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01').outputs.connectionString.value]"
          },
          "azureMcpCollectTelemetry": {
            "value": "true"
          },
          "azureAdTenantId": {
            "value": "[tenant().tenantId]"
          },
          "azureAdClientId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-entra-app'), '2025-04-01').outputs.entraAppClientId.value]"
          },
          "namespaces": {
            "value": "[parameters('mcpNamespaces')]"
          },
          "readOnly": {
            "value": "[parameters('mcpReadOnlyMode')]"
          },
          "useExistingEnvironment": {
            "value": "[parameters('createContainerAppsEnvironment')]"
          },
          "existingEnvironmentName": "[if(parameters('createContainerAppsEnvironment'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-apps-env'), '2025-04-01').outputs.environmentName.value), createObject('value', ''))]",
          "existingEnvironmentResourceGroup": {
            "value": "[parameters('resourceGroupName')]"
          },
          "containerRegistryServer": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-registry'), '2025-04-01').outputs.loginServer.value]"
          },
          "containerImageName": {
            "value": "[parameters('mcpContainerImage')]"
          },
          "containerRegistryUsername": {
            "value": "[parameters('containerRegistryUsername')]"
          },
          "containerRegistryPassword": {
            "value": "[parameters('containerRegistryPassword')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "17466834015983240353"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]",
              "metadata": {
                "description": "Location for all resources"
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Default name for Azure Container App, and name prefix for all other resources"
              }
            },
            "containerAppName": {
              "type": "string",
              "defaultValue": "[parameters('name')]",
              "metadata": {
                "description": "Azure Container App name"
              }
            },
            "environmentName": {
              "type": "string",
              "defaultValue": "[format('{0}-env', parameters('name'))]",
              "metadata": {
                "description": "Environment name for the Container Apps Environment (used when creating new environment)"
              }
            },
            "useExistingEnvironment": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Whether to use an existing Container Apps Environment"
              }
            },
            "existingEnvironmentName": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Name of the existing Container Apps Environment (required if useExistingEnvironment is true)"
              }
            },
            "existingEnvironmentResourceGroup": {
              "type": "string",
              "defaultValue": "[resourceGroup().name]",
              "metadata": {
                "description": "Resource group of the existing Container Apps Environment (required if useExistingEnvironment is true and environment is in different RG)"
              }
            },
            "cpuCores": {
              "type": "string",
              "defaultValue": "0.25",
              "metadata": {
                "description": "Number of CPU cores allocated to the container"
              }
            },
            "memorySize": {
              "type": "string",
              "defaultValue": "0.5Gi",
              "metadata": {
                "description": "Amount of memory allocated to the container"
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Minimum number of replicas"
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 3,
              "metadata": {
                "description": "Maximum number of replicas"
              }
            },
            "appInsightsConnectionString": {
              "type": "string",
              "metadata": {
                "description": "Application Insights connection string"
              }
            },
            "azureMcpCollectTelemetry": {
              "type": "string",
              "metadata": {
                "description": "Whether to collect telemetry"
              }
            },
            "azureAdTenantId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Tenant ID"
              }
            },
            "azureAdClientId": {
              "type": "string",
              "metadata": {
                "description": "Azure AD Client ID"
              }
            },
            "namespaces": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Azure MCP Server namespaces to enable. Leave empty to enable ALL namespaces/tools."
              }
            },
            "readOnly": {
              "type": "bool",
              "defaultValue": true,
              "metadata": {
                "description": "Enable read-only mode. Set to false to allow write operations."
              }
            },
            "containerRegistryServer": {
              "type": "string",
              "metadata": {
                "description": "Container Registry server (e.g., myregistry.azurecr.io)"
              }
            },
            "containerImageName": {
              "type": "string",
              "defaultValue": "azure-mcp-custom:latest",
              "metadata": {
                "description": "Container image name (e.g., azure-mcp-custom:latest)"
              }
            },
            "containerRegistryUsername": {
              "type": "securestring",
              "metadata": {
                "description": "Container Registry username (for admin auth)"
              }
            },
            "containerRegistryPassword": {
              "type": "securestring",
              "metadata": {
                "description": "Container Registry password (for admin auth)"
              }
            }
          },
          "variables": {
            "copy": [
              {
                "name": "namespaceArgs",
                "count": "[length(parameters('namespaces'))]",
                "input": "[createArray('--namespace', parameters('namespaces')[copyIndex('namespaceArgs')])]"
              }
            ],
            "baseArgs": [
              "--transport",
              "http",
              "--outgoing-auth-strategy",
              "UseHostingEnvironmentIdentity",
              "--mode",
              "all"
            ],
            "readOnlyArgs": "[if(parameters('readOnly'), createArray(createArray('--read-only')), createArray())]",
            "serverArgs": "[flatten(concat(createArray(variables('baseArgs')), variables('readOnlyArgs'), variables('namespaceArgs')))]",
            "containerAppsEnvironmentId": "[if(parameters('useExistingEnvironment'), extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('existingEnvironmentResourceGroup')), 'Microsoft.App/managedEnvironments', parameters('existingEnvironmentName')), resourceId('Microsoft.App/managedEnvironments', parameters('environmentName')))]"
          },
          "resources": [
            {
              "condition": "[not(parameters('useExistingEnvironment'))]",
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2024-03-01",
              "name": "[parameters('environmentName')]",
              "location": "[parameters('location')]",
              "properties": {}
            },
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('containerAppName')]",
              "location": "[parameters('location')]",
              "tags": {
                "product": "azmcp"
              },
              "identity": {
                "type": "SystemAssigned"
              },
              "properties": {
                "managedEnvironmentId": "[variables('containerAppsEnvironmentId')]",
                "configuration": {
                  "activeRevisionsMode": "Single",
                  "registries": [
                    {
                      "server": "[parameters('containerRegistryServer')]",
                      "username": "[parameters('containerRegistryUsername')]",
                      "passwordSecretRef": "acr-password"
                    }
                  ],
                  "secrets": [
                    {
                      "name": "acr-password",
                      "value": "[parameters('containerRegistryPassword')]"
                    }
                  ],
                  "ingress": {
                    "external": true,
                    "targetPort": 8080,
                    "allowInsecure": false,
                    "transport": "http",
                    "traffic": [
                      {
                        "weight": 100,
                        "latestRevision": true
                      }
                    ]
                  }
                },
                "template": {
                  "containers": [
                    {
                      "image": "[format('{0}/{1}', parameters('containerRegistryServer'), parameters('containerImageName'))]",
                      "name": "[parameters('containerAppName')]",
                      "command": [],
                      "args": "[variables('serverArgs')]",
                      "resources": {
                        "cpu": "[json(parameters('cpuCores'))]",
                        "memory": "[parameters('memorySize')]"
                      },
                      "env": "[concat(createArray(createObject('name', 'ASPNETCORE_ENVIRONMENT', 'value', 'Production'), createObject('name', 'ASPNETCORE_URLS', 'value', 'http://+:8080'), createObject('name', 'AZURE_TOKEN_CREDENTIALS', 'value', 'managedidentitycredential'), createObject('name', 'AZURE_MCP_INCLUDE_PRODUCTION_CREDENTIALS', 'value', 'true'), createObject('name', 'AZURE_MCP_COLLECT_TELEMETRY', 'value', parameters('azureMcpCollectTelemetry')), createObject('name', 'AzureAd__Instance', 'value', environment().authentication.loginEndpoint), createObject('name', 'AzureAd__TenantId', 'value', parameters('azureAdTenantId')), createObject('name', 'AzureAd__ClientId', 'value', parameters('azureAdClientId')), createObject('name', 'AZURE_TENANT_ID', 'value', parameters('azureAdTenantId')), createObject('name', 'AZURE_LOG_LEVEL', 'value', 'Verbose'), createObject('name', 'AZURE_MCP_DANGEROUSLY_DISABLE_HTTPS_REDIRECTION', 'value', 'true')), if(not(empty(parameters('appInsightsConnectionString'))), createArray(createObject('name', 'APPLICATIONINSIGHTS_CONNECTION_STRING', 'value', parameters('appInsightsConnectionString'))), createArray()))]"
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-scaler",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "100"
                          }
                        }
                      }
                    ]
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
              ]
            }
          ],
          "outputs": {
            "containerAppResourceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('containerAppName'))]"
            },
            "containerAppUrl": {
              "type": "string",
              "value": "[format('https://{0}', reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName')), '2024-03-01').configuration.ingress.fqdn)]"
            },
            "containerAppName": {
              "type": "string",
              "value": "[parameters('containerAppName')]"
            },
            "containerAppPrincipalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName')), '2024-03-01', 'full').identity.principalId]"
            },
            "containerAppEnvironmentId": {
              "type": "string",
              "value": "[variables('containerAppsEnvironmentId')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-apps-env')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-registry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-entra-app')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-contributor",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').contributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Contributor access"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-storage-blob",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').storageBlobDataContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Storage Blob Data Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-storage-table",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').storageTableDataContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Storage Table Data Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-storage-queue",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').storageQueueDataContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Storage Queue Data Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-keyvault-secrets",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').keyVaultSecretsOfficer]"
          },
          "roleDescription": {
            "value": "MCP Server - Key Vault Secrets Officer"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-keyvault-certs",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').keyVaultCertificatesOfficer]"
          },
          "roleDescription": {
            "value": "MCP Server - Key Vault Certificates Officer"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-keyvault-crypto",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').keyVaultCryptoOfficer]"
          },
          "roleDescription": {
            "value": "MCP Server - Key Vault Crypto Officer"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-cosmosdb",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').cosmosDbAccountContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Cosmos DB Account Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-cosmosdb-data-plane",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "cosmosDbAccountName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db'), '2025-04-01').outputs.accountName.value]"
          },
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleType": {
            "value": "contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "14303494873774838853"
            }
          },
          "parameters": {
            "cosmosDbAccountName": {
              "type": "string",
              "metadata": {
                "description": "CosmosDB Account name"
              }
            },
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID to grant access to (e.g., Container App Managed Identity)"
              }
            },
            "roleType": {
              "type": "string",
              "defaultValue": "contributor",
              "allowedValues": [
                "reader",
                "contributor"
              ],
              "metadata": {
                "description": "Role to assign: \"reader\" or \"contributor\""
              }
            }
          },
          "variables": {
            "builtInRoles": {
              "reader": "00000000-0000-0000-0000-000000000001",
              "contributor": "00000000-0000-0000-0000-000000000002"
            }
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2024-05-15",
              "name": "[format('{0}/{1}', parameters('cosmosDbAccountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), parameters('principalId'), variables('builtInRoles')[parameters('roleType')]))]",
              "properties": {
                "roleDefinitionId": "[format('{0}/sqlRoleDefinitions/{1}', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), variables('builtInRoles')[parameters('roleType')])]",
                "principalId": "[parameters('principalId')]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName'))]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "metadata": {
                "description": "The ID of the role assignment"
              },
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments', parameters('cosmosDbAccountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('cosmosDbAccountName')), parameters('principalId'), variables('builtInRoles')[parameters('roleType')]))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-servicebus",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').serviceBusDataOwner]"
          },
          "roleDescription": {
            "value": "MCP Server - Service Bus Data Owner"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-eventgrid",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').eventGridContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Event Grid Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-eventhubs",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').eventHubsDataOwner]"
          },
          "roleDescription": {
            "value": "MCP Server - Event Hubs Data Owner"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-redis",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').redisCacheContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Redis Cache Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-appconfig",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').appConfigurationDataOwner]"
          },
          "roleDescription": {
            "value": "MCP Server - App Configuration Data Owner"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-loganalytics",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').logAnalyticsContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Log Analytics Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-monitoring",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').monitoringContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Monitoring Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-search-service",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').searchServiceContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Search Service Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-search-data",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').searchIndexDataContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Search Index Data Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[parameters('deployMcpServer')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-role-cognitive-services",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "principalId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value]"
          },
          "roleDefinitionId": {
            "value": "[variables('mcpRoles').cognitiveServicesContributor]"
          },
          "roleDescription": {
            "value": "MCP Server - Cognitive Services Contributor"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "511928909197293143"
            }
          },
          "parameters": {
            "principalId": {
              "type": "string",
              "metadata": {
                "description": "Azure Container App Managed Identity principal/object ID (GUID)"
              }
            },
            "roleDefinitionId": {
              "type": "string",
              "metadata": {
                "description": "Azure RBAC role definition ID (GUID) to grant"
              }
            },
            "roleDescription": {
              "type": "string",
              "defaultValue": "",
              "metadata": {
                "description": "Description of the role assignment for documentation purposes"
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.Authorization/roleAssignments",
              "apiVersion": "2022-04-01",
              "name": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]",
              "properties": {
                "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', parameters('roleDefinitionId'))]",
                "principalId": "[parameters('principalId')]",
                "principalType": "ServicePrincipal",
                "description": "[parameters('roleDescription')]"
              }
            }
          ],
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[subscriptionResourceId('Microsoft.Authorization/roleAssignments', guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId')))]"
            },
            "roleAssignmentName": {
              "type": "string",
              "value": "[guid(subscription().id, parameters('principalId'), parameters('roleDefinitionId'))]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app')]"
      ]
    },
    {
      "condition": "[and(parameters('deployMcpServer'), parameters('createAIFoundry'))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2025-04-01",
      "name": "mcp-foundry-role-assignment",
      "resourceGroup": "[parameters('resourceGroupName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "foundryProjectResourceId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiProjectId.value]"
          },
          "entraAppServicePrincipalObjectId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-entra-app'), '2025-04-01').outputs.entraAppServicePrincipalObjectId.value]"
          },
          "entraAppRoleId": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-entra-app'), '2025-04-01').outputs.entraAppRoleId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "languageVersion": "2.0",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.39.26.7824",
              "templateHash": "11459758727301733105"
            }
          },
          "parameters": {
            "foundryProjectResourceId": {
              "type": "string",
              "metadata": {
                "example": "/subscriptions/00000000-0000-0000-0000-000000000000/resourceGroups/myResourceGroup/providers/Microsoft.CognitiveServices/accounts/myAccount/projects/firstProject",
                "description": "Microsoft Foundry project resource ID"
              }
            },
            "entraAppServicePrincipalObjectId": {
              "type": "string",
              "metadata": {
                "description": "Entra App Service Principal Object ID (resourceId in Graph API)"
              }
            },
            "entraAppRoleId": {
              "type": "string",
              "metadata": {
                "description": "Entra App Role ID to assign"
              }
            }
          },
          "variables": {
            "resourceIdParts": "[split(parameters('foundryProjectResourceId'), '/')]",
            "projectResourceGroup": "[variables('resourceIdParts')[4]]",
            "accountName": "[variables('resourceIdParts')[8]]",
            "projectName": "[variables('resourceIdParts')[10]]"
          },
          "imports": {
            "microsoftGraphV1": {
              "provider": "MicrosoftGraph",
              "version": "1.0.0"
            }
          },
          "resources": {
            "foundryProject": {
              "existing": true,
              "type": "Microsoft.CognitiveServices/accounts/projects",
              "apiVersion": "2025-04-01-preview",
              "resourceGroup": "[variables('projectResourceGroup')]",
              "name": "[format('{0}/{1}', variables('accountName'), variables('projectName'))]"
            },
            "appRoleAssignment": {
              "import": "microsoftGraphV1",
              "type": "Microsoft.Graph/appRoleAssignedTo@v1.0",
              "properties": {
                "principalId": "[reference('foundryProject', '2025-04-01-preview', 'full').identity.principalId]",
                "resourceId": "[parameters('entraAppServicePrincipalObjectId')]",
                "appRoleId": "[parameters('entraAppRoleId')]"
              },
              "dependsOn": [
                "foundryProject"
              ]
            }
          },
          "outputs": {
            "roleAssignmentId": {
              "type": "string",
              "value": "[reference('appRoleAssignment').id]"
            },
            "foundryProjectMIPrincipalId": {
              "type": "string",
              "value": "[reference('foundryProject', '2025-04-01-preview', 'full').identity.principalId]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry')]",
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-entra-app')]",
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
      ]
    }
  ],
  "outputs": {
    "resourceGroupName": {
      "type": "string",
      "value": "[parameters('resourceGroupName')]"
    },
    "resourceGroupId": {
      "type": "string",
      "value": "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroupName'))]"
    },
    "logAnalyticsWorkspaceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01').outputs.workspaceId.value]"
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-log-analytics'), '2025-04-01').outputs.workspaceName.value]"
    },
    "applicationInsightsId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01').outputs.applicationInsightsId.value]"
    },
    "applicationInsightsName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01').outputs.applicationInsightsName.value]"
    },
    "applicationInsightsConnectionString": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-app-insights'), '2025-04-01').outputs.connectionString.value]"
    },
    "storageAccountId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountId.value]"
    },
    "storageAccountName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-storage-account'), '2025-04-01').outputs.storageAccountName.value]"
    },
    "cosmosDbAccountId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db'), '2025-04-01').outputs.accountId.value]"
    },
    "cosmosDbAccountName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db'), '2025-04-01').outputs.accountName.value]"
    },
    "cosmosDbEndpoint": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-cosmos-db'), '2025-04-01').outputs.endpoint.value]"
    },
    "searchServiceId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search'), '2025-04-01').outputs.searchServiceId.value]"
    },
    "searchServiceName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search'), '2025-04-01').outputs.searchServiceName.value]"
    },
    "searchServiceEndpoint": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-search'), '2025-04-01').outputs.endpoint.value]"
    },
    "containerAppsEnvironmentId": {
      "type": "string",
      "value": "[if(parameters('createContainerAppsEnvironment'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-apps-env'), '2025-04-01').outputs.environmentId.value, '')]"
    },
    "containerAppsEnvironmentName": {
      "type": "string",
      "value": "[if(parameters('createContainerAppsEnvironment'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-apps-env'), '2025-04-01').outputs.environmentName.value, '')]"
    },
    "aiHubId": {
      "type": "string",
      "value": "[if(parameters('createAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiHubId.value, '')]"
    },
    "aiHubName": {
      "type": "string",
      "value": "[if(parameters('createAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiHubName.value, '')]"
    },
    "aiProjectId": {
      "type": "string",
      "value": "[if(parameters('createAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiProjectId.value, '')]"
    },
    "aiProjectName": {
      "type": "string",
      "value": "[if(parameters('createAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiProjectName.value, '')]"
    },
    "aiFoundryEndpoint": {
      "type": "string",
      "value": "[if(parameters('createAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-ai-foundry'), '2025-04-01').outputs.aiFoundryEndpoint.value, '')]"
    },
    "keyVaultId": {
      "type": "string",
      "value": "[if(parameters('createAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-key-vault'), '2025-04-01').outputs.keyVaultId.value, '')]"
    },
    "keyVaultName": {
      "type": "string",
      "value": "[if(parameters('createAIFoundry'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-key-vault'), '2025-04-01').outputs.keyVaultName.value, '')]"
    },
    "containerRegistryId": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-registry'), '2025-04-01').outputs.registryId.value]"
    },
    "containerRegistryName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-registry'), '2025-04-01').outputs.registryName.value]"
    },
    "containerRegistryLoginServer": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-container-registry'), '2025-04-01').outputs.loginServer.value]"
    },
    "communicationServiceId": {
      "type": "string",
      "value": "[if(parameters('createCommunicationService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-communication-service'), '2025-04-01').outputs.communicationServiceId.value, '')]"
    },
    "communicationServiceName": {
      "type": "string",
      "value": "[if(parameters('createCommunicationService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-communication-service'), '2025-04-01').outputs.communicationServiceName.value, '')]"
    },
    "communicationServiceHostname": {
      "type": "string",
      "value": "[if(parameters('createCommunicationService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-communication-service'), '2025-04-01').outputs.hostname.value, '')]"
    },
    "emailServiceId": {
      "type": "string",
      "value": "[if(parameters('createCommunicationService'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-communication-service'), '2025-04-01').outputs.emailServiceId.value, '')]"
    },
    "mcpServerUrl": {
      "type": "string",
      "value": "[if(parameters('deployMcpServer'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppUrl.value, '')]"
    },
    "mcpServerName": {
      "type": "string",
      "value": "[if(parameters('deployMcpServer'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppName.value, '')]"
    },
    "mcpServerPrincipalId": {
      "type": "string",
      "value": "[if(parameters('deployMcpServer'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-container-app'), '2025-04-01').outputs.containerAppPrincipalId.value, '')]"
    },
    "mcpEntraAppClientId": {
      "type": "string",
      "value": "[if(parameters('deployMcpServer'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-entra-app'), '2025-04-01').outputs.entraAppClientId.value, '')]"
    },
    "mcpEntraAppIdentifierUri": {
      "type": "string",
      "value": "[if(parameters('deployMcpServer'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('resourceGroupName')), 'Microsoft.Resources/deployments', 'deploy-mcp-entra-app'), '2025-04-01').outputs.entraAppIdentifierUri.value, '')]"
    }
  }
}