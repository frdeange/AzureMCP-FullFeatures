# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-dev/main/schemas/v1.0/azure.yaml.json

name: azure-mcp-server
metadata:
  template: azure-mcp-server@0.0.2-beta

infra:
  provider: bicep
  path: ./infra
  outputs:
    AZURE_RESOURCE_GROUP: AZURE_RESOURCE_GROUP
    CONTAINER_APP_NAME: CONTAINER_APP_NAME

hooks:
  preprovision:
    posix:
      shell: sh
      interactive: true
      run: |
        echo ""
        echo "==================================================================="
        echo "  Azure MCP Server - Full Access Deployment"
        echo "==================================================================="
        echo ""
        echo "This template will deploy an Azure MCP Server with access to ALL"
        echo "Azure services (40+ tools). It will assign subscription-level"
        echo "RBAC roles to the Container App's managed identity."
        echo ""
        echo "WARNING: This grants broad permissions. For production, consider"
        echo "limiting access to specific resource groups or services."
        echo ""
        
        # Check if we should use existing ACA environment
        if [ -z "$USE_EXISTING_ACA_ENVIRONMENT" ]; then
          printf "Do you want to use an existing Container Apps Environment? (y/n): "
          read -r USE_EXISTING < /dev/tty
          if [ "$USE_EXISTING" = "y" ] || [ "$USE_EXISTING" = "Y" ]; then
            azd env set USE_EXISTING_ACA_ENVIRONMENT true
            printf "Enter the name of the existing Container Apps Environment: "
            read -r ENV_NAME < /dev/tty
            azd env set EXISTING_ACA_ENVIRONMENT_NAME "$ENV_NAME"
            printf "Enter the resource group of the existing environment (leave empty if same as deployment RG): "
            read -r ENV_RG < /dev/tty
            if [ -n "$ENV_RG" ]; then
              azd env set EXISTING_ACA_ENVIRONMENT_RESOURCE_GROUP "$ENV_RG"
            fi
          else
            azd env set USE_EXISTING_ACA_ENVIRONMENT false
          fi
        fi
        
        # Check read-only mode
        if [ -z "$READ_ONLY_MODE" ]; then
          echo ""
          printf "Do you want to enable read-only mode? (y/n): "
          read -r READ_ONLY < /dev/tty
          if [ "$READ_ONLY" = "y" ] || [ "$READ_ONLY" = "Y" ]; then
            azd env set READ_ONLY_MODE true
          else
            azd env set READ_ONLY_MODE false
          fi
        fi
        
        # Check Application Insights configuration
        if [ -z "$APP_INSIGHTS_CONNECTION_STRING" ]; then
          echo ""
          printf "Do you want to use an existing Application Insights? (y/n): "
          read -r USE_EXISTING_APPINSIGHTS < /dev/tty
          if [ "$USE_EXISTING_APPINSIGHTS" = "y" ] || [ "$USE_EXISTING_APPINSIGHTS" = "Y" ]; then
            printf "Enter the Application Insights connection string: "
            read -r APPINSIGHTS_CONN < /dev/tty
            azd env set APP_INSIGHTS_CONNECTION_STRING "$APPINSIGHTS_CONN"
          else
            azd env set APP_INSIGHTS_CONNECTION_STRING ""
          fi
        fi
    windows:
      shell: pwsh
      interactive: true
      run: |
        Write-Host ""
        Write-Host "==================================================================="
        Write-Host "  Azure MCP Server - Full Access Deployment"
        Write-Host "==================================================================="
        Write-Host ""
        Write-Host "This template will deploy an Azure MCP Server with access to ALL"
        Write-Host "Azure services (40+ tools). It will assign subscription-level"
        Write-Host "RBAC roles to the Container App's managed identity."
        Write-Host ""
        Write-Host "WARNING: This grants broad permissions. For production, consider"
        Write-Host "limiting access to specific resource groups or services."
        Write-Host ""
        
        # Check if we should use existing ACA environment
        $useExisting = $env:USE_EXISTING_ACA_ENVIRONMENT
        if ([string]::IsNullOrEmpty($useExisting)) {
          $response = Read-Host "Do you want to use an existing Container Apps Environment? (y/n)"
          if ($response -eq 'y' -or $response -eq 'Y') {
            azd env set USE_EXISTING_ACA_ENVIRONMENT true
            $envName = Read-Host "Enter the name of the existing Container Apps Environment"
            azd env set EXISTING_ACA_ENVIRONMENT_NAME $envName
            $envRg = Read-Host "Enter the resource group of the existing environment (leave empty if same as deployment RG)"
            if (-not [string]::IsNullOrEmpty($envRg)) {
              azd env set EXISTING_ACA_ENVIRONMENT_RESOURCE_GROUP $envRg
            }
          } else {
            azd env set USE_EXISTING_ACA_ENVIRONMENT false
          }
        }
        
        # Check read-only mode
        $readOnly = $env:READ_ONLY_MODE
        if ([string]::IsNullOrEmpty($readOnly)) {
          Write-Host ""
          $response = Read-Host "Do you want to enable read-only mode? (y/n)"
          if ($response -eq 'y' -or $response -eq 'Y') {
            azd env set READ_ONLY_MODE true
          } else {
            azd env set READ_ONLY_MODE false
          }
        }
        
        # Check Application Insights configuration
        $appInsights = $env:APP_INSIGHTS_CONNECTION_STRING
        if ([string]::IsNullOrEmpty($appInsights)) {
          Write-Host ""
          $response = Read-Host "Do you want to use an existing Application Insights? (y/n)"
          if ($response -eq 'y' -or $response -eq 'Y') {
            $connString = Read-Host "Enter the Application Insights connection string"
            azd env set APP_INSIGHTS_CONNECTION_STRING $connString
          } else {
            azd env set APP_INSIGHTS_CONNECTION_STRING ""
          }
        }

  postup:
    posix:
      shell: sh
      run: |
        echo ""
        echo "==================================================================="
        echo "  âœ… Azure MCP Server Deployed Successfully!"
        echo "==================================================================="
        echo ""
        echo "ðŸ“‹ Use these values to connect from Microsoft Foundry:"
        echo ""
        echo "  Remote MCP Server Endpoint:"
        echo "    $CONTAINER_APP_URL"
        echo ""
        echo "  Authentication: Microsoft Entra â†’ Project Managed Identity"
        echo "  Audience (Entra App Client ID):"
        echo "    $ENTRA_APP_CLIENT_ID"
        echo ""
        echo "==================================================================="
        echo "  ðŸ“– How to connect from Foundry:"
        echo "==================================================================="
        echo "  1. Go to https://ai.azure.com"
        echo "  2. Open your project â†’ Build â†’ Create agent"
        echo "  3. Click '+ Add' in the tools section"
        echo "  4. Select 'Custom' tab â†’ 'Model Context Protocol' â†’ Create"
        echo "  5. Configure:"
        echo "     - Remote MCP Server endpoint: (URL above)"
        echo "     - Authentication: Microsoft Entra â†’ Project Managed Identity"
        echo "     - Audience: (Client ID above)"
        echo "  6. Click 'Connect'"
        echo ""
        echo "==================================================================="
        echo "  ðŸ”§ All deployment outputs:"
        echo "==================================================================="
        echo ""
        azd env get-values | grep -E "^(CONTAINER_APP_URL|ENTRA_APP_CLIENT_ID|ENTRA_APP_IDENTIFIER_URI|ENTRA_APP_OBJECT_ID|ENTRA_APP_SERVICE_PRINCIPAL_ID|AZURE_RESOURCE_GROUP)="
        echo ""
    windows:
      shell: pwsh
      run: |
        Write-Host ""
        Write-Host "==================================================================="
        Write-Host "  âœ… Azure MCP Server Deployed Successfully!"
        Write-Host "==================================================================="
        Write-Host ""
        Write-Host "ðŸ“‹ Use these values to connect from Microsoft Foundry:"
        Write-Host ""
        Write-Host "  Remote MCP Server Endpoint:"
        Write-Host "    $env:CONTAINER_APP_URL"
        Write-Host ""
        Write-Host "  Authentication: Microsoft Entra â†’ Project Managed Identity"
        Write-Host "  Audience (Entra App Client ID):"
        Write-Host "    $env:ENTRA_APP_CLIENT_ID"
        Write-Host ""
        Write-Host "==================================================================="
        Write-Host "  ðŸ“– How to connect from Foundry:"
        Write-Host "==================================================================="
        Write-Host "  1. Go to https://ai.azure.com"
        Write-Host "  2. Open your project â†’ Build â†’ Create agent"
        Write-Host "  3. Click '+ Add' in the tools section"
        Write-Host "  4. Select 'Custom' tab â†’ 'Model Context Protocol' â†’ Create"
        Write-Host "  5. Configure:"
        Write-Host "     - Remote MCP Server endpoint: (URL above)"
        Write-Host "     - Authentication: Microsoft Entra â†’ Project Managed Identity"
        Write-Host "     - Audience: (Client ID above)"
        Write-Host "  6. Click 'Connect'"
        Write-Host ""
        Write-Host "==================================================================="
        Write-Host "  ðŸ”§ All deployment outputs:"
        Write-Host "==================================================================="
        Write-Host ""
        azd env get-values | Select-String -Pattern "^(CONTAINER_APP_URL|ENTRA_APP_CLIENT_ID|ENTRA_APP_IDENTIFIER_URI|ENTRA_APP_OBJECT_ID|ENTRA_APP_SERVICE_PRINCIPAL_ID|AZURE_RESOURCE_GROUP)="
        Write-Host ""